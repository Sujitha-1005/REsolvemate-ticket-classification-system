<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ResolveMate - History</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(to bottom,#E5D9F2,#CDC1FF);
      color:#222;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:15px 30px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    header h1{color:#004b6b;font-size:1.8rem}
    .nav-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .nav-right{
      display:flex;
      align-items:center;
      gap:20px;
    }
    .nav-btn {
      background: #004b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      transition: .3s;
    }
    .nav-btn:hover {
      background: #006c94;
    }
    .nav-btn.active {
      background: #006c94;
      box-shadow: 0 0 0 2px rgba(0, 107, 148, 0.3);
    }
    .user-welcome{
      font-weight:600;
      color:#004b6b;
    }
    .logout{
      background:#c62828;
      color:#fff;
      padding:8px 16px;
      border-radius:6px;
      text-decoration:none;
      font-weight:600;
      transition: .3s;
    }
    .logout:hover {
      background: #d32f2f;
    }
    main{
      flex:1;
      padding:40px 20px;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
    }
    .page-header{
      text-align:center;
      margin-bottom:40px;
    }
    .page-header h2{
      color:#004b6b;
      font-size:2.2rem;
      margin-bottom:10px;
    }
    .page-header p{
      color:#666;
      font-size:1.1rem;
    }
    .controls{
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,.1);
      margin-bottom:30px;
      display:flex;
      gap:20px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .search-box{
      flex:1;
      min-width:300px;
      position:relative;
    }
    .search-box input{
      width:100%;
      padding:12px 45px 12px 15px;
      border:2px solid #ddd;
      border-radius:8px;
      font-size:1rem;
      transition:.3s;
    }
    .search-box input:focus{
      border-color:#004b6b;
      outline:none;
      box-shadow:0 0 0 3px rgba(0,75,107,.1);
    }
    .search-box .search-icon{
      position:absolute;
      right:15px;
      top:50%;
      transform:translateY(-50%);
      color:#666;
    }
    .filter-buttons{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .filter-btn{
      background:#f8f9fa;
      border:2px solid #e9ecef;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      transition:.3s;
      font-weight:600;
    }
    .filter-btn:hover{
      border-color:#004b6b;
    }
    .filter-btn.active{
      background:#004b6b;
      color:#fff;
      border-color:#004b6b;
    }
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;
      margin-bottom:30px;
    }
    .stat-card{
      background:#fff;
      padding:25px;
      border-radius:12px;
      text-align:center;
      box-shadow:0 4px 15px rgba(0,0,0,.1);
      transition:.3s;
    }
    .stat-card:hover{
      transform:translateY(-3px);
    }
    .stat-number{
      font-size:2.5rem;
      font-weight:bold;
      color:#004b6b;
      margin-bottom:8px;
    }
    .stat-label{
      color:#666;
      font-weight:600;
      text-transform:uppercase;
      font-size:.9rem;
      letter-spacing:.5px;
    }
    .history-list{
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,.1);
      overflow:hidden;
    }
    .list-header{
      background:#f8f9fa;
      padding:20px;
      border-bottom:2px solid #e9ecef;
      font-weight:600;
      color:#004b6b;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .history-item{
      border-bottom:1px solid #e9ecef;
      transition:.3s;
    }
    .history-item:hover{
      background:#f8f9fa;
    }
    .history-item:last-child{
      border-bottom:none;
    }
    .item-content{
      padding:20px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:20px;
      align-items:start;
    }
    .item-main{
      flex:1;
    }
    .item-message{
      font-size:1rem;
      line-height:1.6;
      margin-bottom:15px;
      color:#333;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .item-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:10px;
    }
    .tag{
      padding:4px 10px;
      border-radius:20px;
      font-size:.8rem;
      font-weight:600;
      color:#fff;
    }
    .tag.category{background:#28a745}
    .tag.subcategory{background:#007bff}
    .tag.urgency{background:#ffc107;color:#333}
    .tag.sentiment{background:#6f42c1}
    .item-meta{
      color:#666;
      font-size:.9rem;
      display:flex;
      align-items:center;
      gap:15px;
      flex-wrap:wrap;
    }
    .item-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .action-btn{
      background:#004b6b;
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size:.9rem;
      transition:.3s;
    }
    .action-btn:hover{
      background:#006c94;
    }
    .action-btn.delete{
      background:#dc3545;
    }
    .action-btn.delete:hover{
      background:#c82333;
    }
    .empty-state{
      text-align:center;
      padding:60px 20px;
      color:#666;
    }
    .empty-state i{
      font-size:4rem;
      color:#ddd;
      margin-bottom:20px;
    }
    .loading{
      text-align:center;
      padding:40px;
      color:#666;
    }
    .spinner{
      border:4px solid #f3f3f3;
      border-top:4px solid #004b6b;
      border-radius:50%;
      width:40px;
      height:40px;
      animation:spin 1s linear infinite;
      margin:20px auto;
    }
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
    .pagination{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:30px;
    }
    .page-btn{
      padding:10px 15px;
      border:2px solid #004b6b;
      background:#fff;
      color:#004b6b;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      transition:.3s;
    }
    .page-btn:hover,.page-btn.active{
      background:#004b6b;
      color:#fff;
    }
    @media(max-width:768px){
      .controls{
        flex-direction:column;
        align-items:stretch;
      }
      .search-box{
        min-width:100%;
      }
      .item-content{
        grid-template-columns:1fr;
        gap:15px;
      }
      .item-actions{
        justify-content:flex-start;
      }
      .stats-grid{
        grid-template-columns:repeat(2,1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav-left">
      <h1>ResolveMate.</h1>
      <a href="/dashboard" class="nav-btn"><i class="fa fa-tachometer-alt"></i> Dashboard</a>
      <a href="#" class="nav-btn active"><i class="fa fa-history"></i> History</a>
    </div>
    <div class="nav-right">
      <span class="user-welcome">Welcome, <span id="navUserName">User</span></span>
      <a href="#" id="logoutBtn" class="logout"><i class="fa fa-sign-out-alt"></i> Logout</a>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <h2><i class="fa fa-history"></i> Classification History</h2>
        <p>View and manage your previous ticket classifications</p>
      </div>

      <div class="controls">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search messages...">
          <i class="fa fa-search search-icon"></i>
        </div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="billing">Billing</button>
          <button class="filter-btn" data-filter="technical">Technical</button>
          <button class="filter-btn" data-filter="account">Account</button>
          <button class="filter-btn" data-filter="high">High Priority</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalCount">0</div>
          <div class="stat-label">Total Classifications</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="todayCount">0</div>
          <div class="stat-label">Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="highPriorityCount">0</div>
          <div class="stat-label">High Priority</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="averageResponse">0</div>
          <div class="stat-label">Avg Response Time</div>
        </div>
      </div>

      <div class="history-list">
        <div class="list-header">
          <span><i class="fa fa-list"></i> Recent Classifications</span>
          <span id="resultCount">Loading...</span>
        </div>
        
        <div id="loadingDiv" class="loading">
          <div class="spinner"></div>
          <p>Loading your history...</p>
        </div>

        <div id="historyContent"></div>
      </div>

      <div id="pagination" class="pagination" style="display:none;"></div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7XHh5sxVlTscd1zx0lfS9ZW0szYsP4dk",
      authDomain: "resolvemate-c4ecf.firebaseapp.com",
      projectId: "resolvemate-c4ecf",
      storageBucket: "resolvemate-c4ecf.appspot.com",
      messagingSenderId: "909784257137",
      appId: "1:909784257137:web:4eef0d71776fed0c3301d0",
      measurementId: "G-YJ0RP7Q936"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allPredictions = [];
    let filteredPredictions = [];
    let currentUser = null;

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/login";
        return;
      }
      currentUser = user;
      const docRef = doc(db, "users", user.uid);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        document.getElementById('navUserName').textContent = data.full_name || "User";
      } else {
        document.getElementById('navUserName').textContent = user.email;
      }
      
      // Load predictions after user is authenticated
      await loadPredictions();
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = "/login";
      });
    });

    // Load predictions from Firestore
    async function loadPredictions() {
      try {
        const q = query(
          collection(db, "predictions"),
          where("user_id", "==", currentUser.uid),
          orderBy("timestamp", "desc"),
          limit(100)
        );
        
        const querySnapshot = await getDocs(q);
        allPredictions = [];
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          allPredictions.push({
            id: doc.id,
            ...data,
            timestamp: data.timestamp?.toDate() || new Date()
          });
        });
        
        filteredPredictions = [...allPredictions];
        displayPredictions();
        updateStats();
        
        document.getElementById('loadingDiv').style.display = 'none';
        
      } catch (error) {
        console.error('Error loading predictions:', error);
        document.getElementById('loadingDiv').innerHTML = 
          '<p style="color: red;"><i class="fa fa-exclamation-triangle"></i> Error loading history. Please try again.</p>';
      }
    }

    // Display predictions
    function displayPredictions() {
      const content = document.getElementById('historyContent');
      const resultCount = document.getElementById('resultCount');
      
      if (filteredPredictions.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <i class="fa fa-inbox"></i>
            <h3>No classifications found</h3>
            <p>Start classifying tickets to see your history here.</p>
            <a href="/dashboard" style="color: #004b6b; text-decoration: none; font-weight: 600;">
              <i class="fa fa-plus"></i> Classify Your First Ticket
            </a>
          </div>
        `;
        resultCount.textContent = '0 results';
        return;
      }
      
      resultCount.textContent = `${filteredPredictions.length} result${filteredPredictions.length !== 1 ? 's' : ''}`;
      
      content.innerHTML = filteredPredictions.map(prediction => `
        <div class="history-item" data-id="${prediction.id}">
          <div class="item-content">
            <div class="item-main">
              <div class="item-message">${prediction.text || 'No message'}</div>
              <div class="item-tags">
                <span class="tag category">${prediction.category || 'N/A'}</span>
                <span class="tag subcategory">${prediction.subcategory || 'N/A'}</span>
                <span class="tag urgency">${prediction.urgency || 'N/A'}</span>
                <span class="tag sentiment">${prediction.sentiment || 'N/A'}</span>
              </div>
              <div class="item-meta">
                <span><i class="fa fa-clock"></i> ${formatDate(prediction.timestamp)}</span>
                ${prediction.invoice && prediction.invoice !== 'Not found' ? 
                  `<span><i class="fa fa-file-invoice"></i> ${prediction.invoice}</span>` : ''}
              </div>
            </div>
            <div class="item-actions">
              <button class="action-btn" onclick="viewDetails('${prediction.id}')">
                <i class="fa fa-eye"></i> View
              </button>
              <button class="action-btn" onclick="reclassify('${encodeURIComponent(prediction.text)}')">
                <i class="fa fa-redo"></i> Retry
              </button>
              <button class="action-btn delete" onclick="deleteItem('${prediction.id}')">
                <i class="fa fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Update statistics
    function updateStats() {
      const total = allPredictions.length;
      const today = allPredictions.filter(p => {
        const predDate = new Date(p.timestamp).toDateString();
        const todayDate = new Date().toDateString();
        return predDate === todayDate;
      }).length;
      
      const highPriority = allPredictions.filter(p => 
        p.urgency && (p.urgency.toLowerCase().includes('high') || p.urgency.toLowerCase().includes('urgent'))
      ).length;
      
      document.getElementById('totalCount').textContent = total;
      document.getElementById('todayCount').textContent = today;
      document.getElementById('highPriorityCount').textContent = highPriority;
      document.getElementById('averageResponse').textContent = '< 1min'; // Static for demo
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      filteredPredictions = allPredictions.filter(p => 
        (p.text && p.text.toLowerCase().includes(searchTerm)) ||
        (p.category && p.category.toLowerCase().includes(searchTerm)) ||
        (p.subcategory && p.subcategory.toLowerCase().includes(searchTerm))
      );
      displayPredictions();
    });

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active state
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const filter = btn.dataset.filter;
        if (filter === 'all') {
          filteredPredictions = [...allPredictions];
        } else if (filter === 'high') {
          filteredPredictions = allPredictions.filter(p => 
            p.urgency && (p.urgency.toLowerCase().includes('high') || p.urgency.toLowerCase().includes('urgent'))
          );
        } else {
          filteredPredictions = allPredictions.filter(p => 
            (p.category && p.category.toLowerCase().includes(filter)) ||
            (p.subcategory && p.subcategory.toLowerCase().includes(filter))
          );
        }
        displayPredictions();
      });
    });

    // Global functions for item actions
    window.viewDetails = function(id) {
      const prediction = allPredictions.find(p => p.id === id);
      if (prediction) {
        // Create a modal or redirect to results page
        const text = encodeURIComponent(prediction.text);
        window.location.href = `/results?text=${text}`;
      }
    };

    window.reclassify = function(text) {
      const decodedText = decodeURIComponent(text);
      window.location.href = `/dashboard?prefill=${encodeURIComponent(decodedText)}`;
    };

    window.deleteItem = async function(id) {
      if (!confirm('Are you sure you want to delete this classification?')) return;
      
      try {
        await deleteDoc(doc(db, "predictions", id));
        allPredictions = allPredictions.filter(p => p.id !== id);
        filteredPredictions = filteredPredictions.filter(p => p.id !== id);
        displayPredictions();
        updateStats();
        
        // Show success message briefly
        const resultCount = document.getElementById('resultCount');
        const originalText = resultCount.textContent;
        resultCount.textContent = 'Deleted successfully!';
        resultCount.style.color = '#28a745';
        setTimeout(() => {
          resultCount.textContent = originalText;
          resultCount.style.color = '';
        }, 2000);
        
      } catch (error) {
        console.error('Error deleting prediction:', error);
        alert('Error deleting item. Please try again.');
      }
    };

    // Format date helper
    function formatDate(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      
      return date.toLocaleDateString();
    }
  </script>
</body>
</html>